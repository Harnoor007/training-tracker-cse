name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js using NVM
      run: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 20
        nvm use 20

    - name: Pull latest changes
      run: |
        git pull

    - name: Stop running servers
      run: |
        pkill -f node || true

    - name: Install backend dependencies
      run: |
        cd backend
        npm install

    - name: Start backend server
      run: |
        cd backend
        node index.js &
      

    - name: Install client dependencies
      run: |
        cd client
        npm install

    - name: Build client
      run: |
        cd client
        npm run build

    - name: Install serve globally
      run: npm install -g serve

    - name: Serve client
      run: |
        cd client
        serve -s dist &
